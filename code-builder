#!/usr/bin/env python

#############################################################################
# Author  : Jerome ODIER, Christophe SMEKENS
# Email   : odier@hypnos3d.com, smekens@hypnos3d.com
#
# Version : 1.0 beta (2012)
#
#
# This file is part of CODE-BUILDER.
#
#  u-autotool is free software; you can redistribute it and/or modify
#  it under the terms of the GNU Lesser General Public License as published
#  by the Free Software Foundation; either version 3 of the License, or
#  (at your option) any later version.
#
#  u-autotool is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU Lesser General Public License for more details.
#
#  You should have received a copy of the GNU Lesser General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#############################################################################

import sys

import cb.utils
import cb.parse
import cb.check
import cb.emit

#############################################################################

try:
	import os, xml.dom.minidom

except ImportError, e:
	cb.utils.fatal(e)

#############################################################################
# VARIABLES								    #
#############################################################################

CTX = {
	'name': 'noname',
	'major': 0,
	'minor': 0,

	'int_asset': {},
	'int_types': [],
	'int_profiles': [],
	'int_extensions': [],
	'int_constraints': [],

	'imp_extras': [],
	'imp_ctors': [],
	'imp_dtors': [],
	'imp_profiles': {},

	'options': None,
	'lang': None,

	'debug': 0,
	'ooops': 0,
	'error': 0,

	'cnt': 0x10000,
}

#############################################################################
# CODE-BUILDER								    #
#############################################################################

def codebuilder_load_xml(ctx, fileName):
	#####################################################################

	if ctx['options'].verbose:
		print('Loading \'%s\'...' % fileName)

	#####################################################################

	try:
		doc = xml.dom.minidom.parse(fileName)

		includes = doc.getElementsByTagName('include')

		if len(includes) > 0:

			dirName = os.path.dirname(fileName)

			if len(dirName) == 0:
				dirName = '.'

			for include in includes:

				url = include.getStripedAttribute('url')

				if url[0] != os.sep:
					url = dirName + os.sep + url

				#############################################

				subdoc = codebuilder_load_xml(ctx, url)

				for node in subdoc.documentElement.childNodes:
					include.parentNode.appendChild(node.cloneNode(1))

				#############################################

	except:
		print('[Error] XML error in file `%s`, %s !' % (fileName, sys.exc_info()[1]))

		sys.exit(1)

	return doc

#############################################################################

def codebuilder_load(ctx, fileName):
	doc = codebuilder_load_xml(ctx, fileName)

	cb.parse.parseInterface(ctx,
		doc.getElementsByTagName('interface')
	)

	cb.parse.parseImplementation(ctx,
		doc.getElementsByTagName('implementation')
	)

#############################################################################

def codebuilder_check(ctx):
	cb.check.interface(ctx)
	cb.check.implementation(ctx)

	cb.utils.status(CTX)

#############################################################################

def codebuilder_emit(ctx):
	cb.emit.interface(ctx)
	cb.emit.implementation(ctx)

#############################################################################

from optparse import OptionParser

#############################################################################

if __name__ == '__main__':
	#####################################################################

	parse = OptionParser('usage: %prog [options] [filename]')

	parse.add_option('-a', '--authors',
			action='store_true', dest='authors', help='show authors')
	parse.add_option('-v', '--version',
			action='store_true', dest='version', help='show version')
	parse.add_option('-l', '--lang',
			action='store', dest='lang', help='???')
	parse.add_option('-p', '--profiles',
			action='store', dest='profiles', help='???')
	parse.add_option('', '--verbose',
			action='store_true', dest='verbose', help='set this program verbose')

	(options, args) = parse.parse_args()

	CTX['options'] = options

	#####################################################################

	if options.authors:
		print('Jerome ODIER, Christophe SMEKENS')
		sys.exit()

	if options.version:
		print('code-builder-1.0')
		sys.exit()

	#####################################################################

	list = [
		'CodeBuilder.xml',
	]

	if   len(args) == 0:
		fileName = os.path.normcase(list[0])
	elif len(args) == 1:
		fileName = os.path.normcase(args[0])
	else:
		parse.error('syntax error')
		sys.exit(1)

	#####################################################################

	if not os.path.exists(fileName):
		parse.error('incorrect filename \'%s\'' % fileName)
		sys.exit(1)

	#####################################################################

	try:
		if options.lang:
			__import__('cb.lang.%s' % options.lang)
		else:
			__import__('cb.lang.%s' %     'c'     )

		CTX['lang'] = sys.modules['cb.lang.c']

	except ImportError, e:
		parse.error('incorrect language \'%s\'' % options.lang)
		sys.exit(1)

	#####################################################################

	codebuilder_load(CTX, fileName)

	codebuilder_check(CTX)

	if CTX['error'] == 0:
		codebuilder_emit(CTX)

#############################################################################

